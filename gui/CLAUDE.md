# CLAUDE.md - GUI应用程序技术指南

## 模块概述
专业级Mars日志分析GUI应用，提供高性能日志浏览、搜索、过滤、统计和可视化功能。基于Python tkinter构建，支持百万级日志条目流畅处理。项目已完成模块化重构，将原始3784行单文件拆分为清晰的模块结构。

## 核心文件

### mars_log_analyzer_modular.py
模块化版本，当前主要使用的程序入口。继承自原始版本，使用模块化组件实现功能。

### mars_log_analyzer_pro.py
原始专业版GUI主程序，现作为基类保留。包含所有功能的完整实现。

## 模块化架构

### 目录结构
```
gui/
├── mars_log_analyzer_modular.py    # 模块化版本入口
├── mars_log_analyzer_pro.py        # 原始版本（基类）
├── modules/                        # 功能模块
│   ├── data_models.py              # 数据模型（LogEntry、FileGroup）
│   ├── file_operations.py          # 文件操作（加载、导出）
│   ├── filter_search.py            # 过滤和搜索逻辑
│   ├── ips_tab.py                  # IPS崩溃分析标签页
│   ├── push_tab.py                 # iOS推送测试标签页
│   └── sandbox_tab.py              # iOS沙盒浏览标签页 🆕 (含搜索功能)
└── components/                      # UI组件
    ├── improved_lazy_text.py       # 虚拟滚动文本组件
    └── scrolled_text_with_lazy_load.py # 懒加载文本组件
```

### 模块职责

#### mars_log_analyzer_modular.py
- 继承`MarsLogAnalyzerPro`
- 重写关键方法使用模块化组件
- 保持100%功能兼容性

#### 原始架构设计
```
MarsLogAnalyzerPro (主窗口)
├── 菜单栏 (文件/工具/视图/帮助)
├── 工具栏 (快速操作按钮)
├── 主面板
│   ├── 左侧面板 (文件列表/统计)
│   ├── 中央面板 (日志显示/多标签)
│   └── 右侧面板 (详情/过滤器)
└── 状态栏 (进度/信息)
```

## 核心类（原始实现）

##### MarsLogAnalyzerPro
- **职责**: 主应用程序框架
- **关键方法**:
  - `__init__()`: 初始化UI和组件
  - `load_file()`: 加载日志文件
  - `search_logs()`: 搜索功能
  - `filter_logs()`: 过滤功能
  - `export_logs()`: 导出功能
  - `show_statistics()`: 统计显示

##### LogEntry
- **职责**: 日志条目数据模型
- **属性**:
  - `level`: 日志级别(INFO/WARNING/ERROR/DEBUG/VERBOSE/CRASH)
  - `timestamp`: 时间戳
  - `module`: 模块名
  - `content`: 日志内容
  - `thread_id`: 线程ID
  - `is_crash`: 是否崩溃日志
- **崩溃检测逻辑**:
  - 精确匹配"*** Terminating app due to uncaught exception"
  - 避免误判普通错误为崩溃

##### FastLogLoader
- **职责**: 高性能日志加载器
- **特性**:
  - 多线程加载
  - 进度回调
  - 增量加载
  - 内存优化

#### 关键功能实现

##### 1. 文件加载
```python
# 支持的文件类型
- .xlog: Mars压缩日志（自动解码）
- .log: 文本日志
- .txt: 文本日志
- .ips: iOS崩溃报告
```

##### 2. 搜索功能
- **普通搜索**: 字符串匹配
- **正则搜索**: 完整正则表达式支持
- **高亮显示**: 搜索结果高亮
- **搜索历史**: 最近10次搜索记录

##### 3. 过滤系统
- **日志级别过滤**: ERROR/WARNING/INFO/DEBUG/VERBOSE
- **时间范围过滤**: 开始/结束时间选择
- **模块过滤**: 按模块名筛选
- **线程过滤**: 按线程ID筛选
- **组合过滤**: 多条件AND逻辑

##### 4. 统计分析
- **级别分布**: 饼图显示各级别占比
- **时间分布**: 时间线图表
- **模块统计**: Top 10模块
- **错误分析**: 错误类型分类
- **性能指标**: 加载时间、内存占用

##### 5. IPS崩溃分析
- **自动解析**: JSON格式解析
- **符号化支持**: 配合dSYM文件
- **堆栈美化**: 格式化显示
- **导入路径修复**:
  ```python
  sys.path.append(os.path.join(os.path.dirname(os.path.dirname(__file__)), 'tools'))
  from ips_parser import IPSParser, IPSSymbolicator
  ```

##### 6. 导出功能
- **格式支持**: TXT/JSON/CSV
- **选择导出**: 当前视图/过滤结果/全部
- **批量导出**: 多文件合并导出

#### 性能优化

##### 内存管理
1. **懒加载机制**: 仅加载可见区域
2. **数据分页**: 大文件分块处理
3. **垃圾回收**: 主动触发GC
4. **缓存策略**: LRU缓存常用数据

##### 渲染优化
1. **虚拟滚动**: 仅渲染可见行
2. **批量更新**: 减少重绘次数
3. **异步加载**: 后台线程处理
4. **增量渲染**: 分批显示结果

##### 响应优化
1. **多线程**: 耗时操作异步执行
2. **进度反馈**: 实时显示进度
3. **取消机制**: 可中断长时间操作
4. **缓存预热**: 预加载常用数据

## 组件集成

### 依赖的组件
- `components/improved_lazy_text.py`: 懒加载文本组件
- `components/scrolled_text_with_lazy_load.py`: 滚动文本组件（备用）
- `../decoders/decode_mars_nocrypt_log_file_py3.py`: 解码器
- `../decoders/fast_decoder.py`: 快速解码器
- `../tools/ips_parser.py`: IPS解析器

### 外部依赖
```python
- tkinter: GUI框架
- matplotlib: 图表绘制
- threading: 多线程支持
- queue: 线程通信
- json: JSON处理
- csv: CSV导出
- re: 正则表达式
```

## UI/UX设计原则

### 界面布局
1. **模块化设计**: 可独立更新各面板
2. **响应式布局**: 自适应窗口大小
3. **可配置界面**: 面板可显示/隐藏
4. **多标签支持**: 同时查看多个文件

### 交互设计
1. **快捷键支持**: 常用操作键盘快捷方式
2. **拖放支持**: 文件拖放加载
3. **右键菜单**: 上下文相关操作
4. **工具提示**: 悬停显示帮助信息

### 视觉设计
1. **颜色编码**: 不同级别不同颜色
2. **图标系统**: 直观的功能图标
3. **主题支持**: 亮色/暗色主题（规划中）
4. **字体配置**: 可调整字体大小

## 开发指南

### 添加新功能
1. **菜单项**: 在`create_menu()`中添加
2. **工具按钮**: 在`create_toolbar()`中添加
3. **面板**: 在`create_panels()`中添加
4. **快捷键**: 在`setup_shortcuts()`中绑定

### 性能测试
```python
# 性能测试用例
- 10MB文件: <1秒加载
- 100MB文件: <5秒加载
- 1GB文件: <30秒加载
- 搜索响应: <100ms
- 过滤响应: <200ms
```

### 调试技巧
1. **日志输出**: 使用logging模块
2. **性能分析**: cProfile分析瓶颈
3. **内存分析**: memory_profiler检测泄漏
4. **UI调试**: 使用tkinter的trace功能

## 常见问题

### Q: 大文件加载慢？
- 使用快速解码器
- 启用多线程加载
- 增加缓存大小
- 考虑分片加载

### Q: 界面卡顿？
- 检查主线程阻塞
- 优化渲染逻辑
- 减少UI更新频率
- 使用虚拟滚动

### Q: 内存占用高？
- 启用懒加载
- 及时释放资源
- 限制缓存大小
- 使用生成器模式

### Q: IPS解析失败？
- 检查文件格式
- 确认路径引用正确
- 验证ips_parser导入
- 查看错误日志

## 维护注意事项

### 代码规范
1. **命名规范**: snake_case for methods, CamelCase for classes
2. **文档字符串**: 所有公共方法需要docstring
3. **类型注解**: 使用typing模块
4. **错误处理**: 明确的try-except块

### 测试要求
1. **单元测试**: 核心功能覆盖
2. **集成测试**: 组件交互测试
3. **性能测试**: 基准测试数据
4. **UI测试**: 界面功能验证

### 版本管理
1. **功能分支**: feature/xxx
2. **修复分支**: bugfix/xxx
3. **发布标签**: v1.x.x
4. **更新日志**: CHANGELOG.md

## 未来规划

### 短期目标（1-3月）
- [ ] 暗色主题支持
- [ ] 实时日志跟踪
- [ ] 插件系统架构
- [ ] 云端同步功能

### 中期目标（3-6月）
- [ ] AI日志分析
- [ ] 性能基准测试
- [ ] 多语言支持
- [ ] 自定义过滤器

### 长期目标（6-12月）
- [ ] Web版本开发
- [ ] 分布式日志分析
- [ ] 机器学习异常检测
- [ ] 自动化报告生成

## 版本更新历史

### v2.1.0 (2025-10-09) - 模块分组和崩溃检测增强

#### 新增功能
1. ✅ **日志模块分组增强**
   - 支持 `<Chair>` 格式：`[<Chair> 日志内容]`
   - 支持 `[Plugin]` 格式：`[[Plugin] 日志内容]`
   - 保持原有 `<AnimationCenter>` 格式支持
   - 自动提取模块名并归类

2. ✅ **崩溃日志检测优化**
   - 修复懒加载导致的多行崩溃堆栈合并问题
   - 每个堆栈行单独创建LogEntry，确保正确识别
   - iOS堆栈格式完全支持
   - Crash模块自动置顶显示

3. ✅ **代码架构优化**
   - 统一LogEntry数据模型
   - 移除 mars_log_analyzer_pro.py 中的重复LogEntry类定义
   - 统一使用 `gui/modules/data_models.py`
   - 避免代码重复和维护问题

#### 技术改进
- **文件加载逻辑优化**:
  - 崩溃堆栈行不再合并为多行字符串
  - 每行独立处理，保证正则匹配准确性
- **模块排序优化**:
  - Crash模块始终排在第一位
  - 其他模块按字母顺序排列
- **代码统一**:
  - 单一LogEntry源文件，避免同步问题
  - 简化维护和更新流程

### v2.0.0 (2025-09-27) - 模块化重构

#### 完成的工作
1. ✅ **代码拆分**: 将3784行单文件拆分为5个功能模块
2. ✅ **功能保持**: 100%功能兼容，所有特性正常工作
3. ✅ **问题修复**:
   - 修复`filter_logs()`方法未重写问题
   - 修复`FileGroup.get_display_name()`不一致
   - 统一所有过滤路径逻辑
4. ✅ **文档完善**: 为每个模块创建技术文档

#### 模块化优势
- **代码组织**: 清晰的模块边界和职责分离
- **可维护性**: 易于定位和修改特定功能
- **可测试性**: 模块可独立测试
- **可扩展性**: 便于添加新功能

#### 技术债务（已改善）
1. ~~**需要重构**: 搜索功能模块化~~ ✅ 已完成
2. ~~**代码清理**: 移除冗余代码~~ ✅ 已完成
3. ~~**文档完善**: API文档补充~~ ✅ 已完成
4. ~~**LogEntry统一**: 移除重复定义~~ ✅ 已完成 (v2.1.0)