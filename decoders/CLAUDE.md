# CLAUDE.md - 解码器模块技术指南

## 模块概述
此目录包含Mars xlog文件解码的核心实现。Mars是腾讯的高性能日志框架，xlog是其压缩加密的二进制日志格式。

## 文件说明

### decode_mars_nocrypt_log_file.py
- **用途**: 原始Python 2版本解码器（遗留代码）
- **特性**:
  - 支持早期Mars日志格式
  - 基础解码功能
  - 兼容Python 2.7
- **维护建议**: 仅保留用于兼容性，不建议添加新功能

### decode_mars_nocrypt_log_file_py3.py
- **用途**: 标准Python 3解码器（主要维护版本）
- **核心功能**:
  - 多种压缩格式支持（MAGIC_COMPRESS_START、MAGIC_NO_COMPRESS_START等）
  - 4字节和64字节密钥加密支持
  - zlib解压缩
  - 日志缓冲区完整性验证
  - 损坏数据优雅处理
- **关键函数**:
  - `ParseFile(file_path)`: 主解码入口
  - `GetLogStartPos(buffer, count)`: 查找日志起始位置
  - `DecodeBuffer(buffer, start_pos, out_buffer, is_sync)`: 缓冲区解码
- **升级注意事项**:
  - 保持向后兼容性
  - 新增魔数需要更新MAGIC常量定义
  - 错误处理需要详细日志

### fast_decoder.py
- **用途**: 高性能解码器（大文件优化）
- **优化策略**:
  - 使用内存映射减少I/O
  - 批量处理缓冲区
  - 并行解码支持（可选）
  - 减少字符串操作
- **适用场景**:
  - 文件大于10MB
  - 批量处理需求
  - 实时性要求高
- **性能指标**:
  - 比标准解码器快2-3倍
  - 内存占用减少40%

### optimized_decoder.py
- **用途**: 内存优化解码器（资源受限环境）
- **优化策略**:
  - 流式处理，避免全文件加载
  - 智能缓冲区管理
  - 增量解码输出
  - 垃圾回收优化
- **适用场景**:
  - 内存受限环境（<2GB）
  - 超大文件（>100MB）
  - 嵌入式系统
- **特殊功能**:
  - 支持断点续传
  - 支持部分解码

## Mars xlog格式详解

### 文件结构
```
[Header][Log Entry 1][Log Entry 2]...[Log Entry N][MAGIC_END]
```

### 魔数定义
```python
MAGIC_NO_COMPRESS_START = 0x03       # 未压缩，无加密
MAGIC_NO_COMPRESS_START1 = 0x04      # 未压缩，4字节密钥
MAGIC_COMPRESS_START = 0x05          # 压缩，无加密
MAGIC_COMPRESS_START1 = 0x06         # 压缩，4字节密钥
MAGIC_COMPRESS_START2 = 0x07         # 压缩，64字节密钥（新版）
MAGIC_COMPRESS_NO_CRYPT_START = 0x08 # 压缩，明文
MAGIC_SYNC_NO_CRYPT_START = 0x09     # 同步日志，明文
MAGIC_END = 0x00                      # 结束标记
```

### 日志条目格式
```
[魔数(1)][序列号(2)][开始时间(1)][结束时间(1)][长度(4)][密钥(可选)][数据][MAGIC_END]
```

## 开发指南

### 添加新的解码格式
1. 在魔数定义中添加新常量
2. 更新`DecodeBuffer`函数的switch逻辑
3. 实现对应的解压缩/解密逻辑
4. 添加单元测试

### 性能优化建议
1. **I/O优化**
   - 使用缓冲读取
   - 减少系统调用
   - 考虑异步I/O

2. **内存优化**
   - 复用缓冲区
   - 及时释放大对象
   - 使用生成器模式

3. **CPU优化**
   - 避免重复计算
   - 使用内置函数
   - 考虑Cython加速

### 错误处理策略
1. **损坏数据**
   - 跳过损坏块
   - 记录错误位置
   - 尝试恢复后续数据

2. **格式不兼容**
   - 检测版本号
   - 提供明确错误信息
   - 建议使用正确解码器

## 测试要求

### 单元测试
- 每个解码器需要对应的test_*.py文件
- 覆盖所有魔数格式
- 包含边界条件测试
- 损坏数据测试

### 性能测试
- 基准测试脚本
- 不同文件大小的性能数据
- 内存占用监控
- CPU使用率分析

## 维护注意事项

1. **版本兼容性**
   - 新功能不破坏旧格式解析
   - 保留降级路径
   - 版本号管理

2. **代码质量**
   - 遵循PEP 8规范
   - 添加类型注解（Python 3.5+）
   - 完善的文档字符串
   - 代码审查流程

3. **安全考虑**
   - 输入验证
   - 缓冲区溢出防护
   - 密钥安全存储
   - 日志脱敏

## 常见问题

### Q: 解码失败怎么办？
1. 检查文件是否完整
2. 确认xlog版本
3. 尝试不同解码器
4. 查看错误日志

### Q: 如何提升解码速度？
1. 使用fast_decoder.py
2. 增加缓冲区大小
3. 并行处理多文件
4. 考虑SSD存储

### Q: 内存溢出如何处理？
1. 使用optimized_decoder.py
2. 分批处理
3. 增加系统内存
4. 优化代码逻辑

## 未来规划
- [ ] 支持实时流式解码
- [ ] 添加GUI解码界面
- [ ] 支持更多压缩算法
- [ ] 云端解码服务
- [ ] 机器学习异常检测