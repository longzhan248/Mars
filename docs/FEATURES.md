# 功能详细说明 (FEATURES)

本文档详细说明 Mars Log Analyzer 的各项功能，包括使用方法、技术实现和最佳实践。

## 目录
- [Mars 日志分析](#mars-日志分析)
- [AI 智能诊断](#ai-智能诊断)
- [IPS 崩溃解析](#ips-崩溃解析)
- [iOS 推送测试](#ios-推送测试)
- [iOS 沙盒浏览](#ios-沙盒浏览)
- [dSYM 分析](#dsym-分析)
- [LinkMap 分析](#linkmap-分析)
- [iOS 代码混淆](#ios-代码混淆)

## Mars 日志分析

### 功能概述
解码和分析 Mars xlog 文件，提供强大的搜索、过滤和分析功能。支持百万级日志的流畅处理。

### 界面布局
- **日志查看标签页**：包含完整的搜索与过滤功能
  - 关键词搜索（支持字符串/正则模式）
  - 日志级别过滤
  - 模块过滤
  - 时间范围过滤
  - 导出功能
- **模块分组标签页**：
  - 模块列表实时搜索：快速定位目标模块
  - 模块内搜索：在选定模块的日志中搜索
- 紧凑的2行布局设计，非全屏模式下完整显示所有功能

### 文本选择和复制
所有日志文本区域支持：
- ✅ **鼠标选择**：拖动鼠标选择文本，蓝色高亮显示
- ✅ **键盘快捷键**：Cmd+C (macOS) 或 Ctrl+C (Windows/Linux) 复制
- ✅ **全选**：Cmd+A 或 Ctrl+A
- ✅ **右键菜单**：系统原生的复制功能
- ✅ **失去焦点保持高亮**：浅蓝色显示选中区域
- ❌ **只读保护**：阻止键盘输入和粘贴，但不影响复制

### 时间过滤功能
GUI提供强大的时间过滤功能，支持多种时间格式输入：

#### 支持的时间格式
- **完整格式**: `2025-09-21 14:00:00` - 精确到秒
- **日期格式**: `2025-09-21` - 过滤整天的日志
- **时间格式**: `14:00:00` 或 `14:00` - 跨天过滤特定时间段
- **留空**: 开始时间留空表示从最早，结束时间留空表示到最后

#### 使用方法
1. 在时间范围输入框中输入开始和结束时间
2. 按Enter键或点击"应用过滤"按钮
3. 切换日志级别或模块会自动应用所有过滤条件

#### 支持的日志时间戳格式
- 带时区：`[2025-09-21 +8.0 13:09:49.038]`
- 无时区：`[2025-09-21 13:09:49.038]`
- 标准格式：`2025-09-21 13:09:49`

### 搜索功能
- **普通搜索**: 输入关键词进行字符串匹配
- **正则搜索**: 切换到"正则"模式使用正则表达式
- **快捷键**: 在搜索框按Enter键立即搜索
- **高亮显示**: 搜索结果自动高亮显示

### 自定义模块分组规则 🎯

#### 功能介绍
允许用户定义自己的日志模块分组规则，实现更灵活的日志分类。

#### 使用方法
1. 切换到"模块分组"标签页
2. 点击模块列表右上方的"自定义规则"按钮
3. 在弹出的规则管理对话框中：
   - **添加规则**：点击"添加"按钮，输入规则名称、匹配模式、目标模块名和匹配类型
   - **编辑规则**：选中规则后点击"编辑"按钮修改
   - **删除规则**：选中规则后点击"删除"按钮移除
   - **应用规则**：点击"应用规则"重新加载日志应用新规则

#### 匹配类型
- **字符串模式**：
  - 简单的包含匹配，检查日志内容中是否包含指定字符串
  - 示例：输入 `Animation` 可匹配所有包含"Animation"的日志
  - 不修改日志内容
- **正则模式**：
  - 使用正则表达式匹配
  - 支持捕获组提取并清理日志内容
  - 示例：`^\[<Chair>\s*(.*)$` 匹配 `[<Chair> xxx` 格式并提取 `xxx` 作为内容
  - 更灵活但需要正则表达式知识

#### 规则优先级
内置模块标识（如 `<Chair>`, `[Plugin]`）> 自定义规则 > 默认模块标签

#### 规则存储
- 规则保存在 `gui/custom_module_rules.json` 文件
- 格式示例：
```json
[
  {
    "name": "动画模块",
    "pattern": "Animation",
    "module": "Animation",
    "type": "字符串"
  },
  {
    "name": "Chair格式",
    "pattern": "^\\[<Chair>\\s*(.*)$",
    "module": "Chair",
    "type": "正则"
  }
]
```

### 模块列表搜索功能 🔍

#### 功能介绍
在模块分组标签页的模块列表上方提供实时搜索功能，帮助用户在大量模块中快速定位目标模块。

#### 使用方法
1. 切换到"模块分组"标签页
2. 在模块列表上方的搜索框中输入关键词
3. 列表自动过滤，只显示包含关键词的模块
4. 点击"×"按钮或清空搜索框恢复显示所有模块

#### 功能特性
- **实时搜索**: 输入即搜索，无需点击按钮
- **不区分大小写**: 自动忽略大小写进行匹配
- **部分匹配**: 只要模块名包含关键词即可匹配
- **保持排序**: Crash模块始终置顶，其他模块按字母排序
- **统计完整**: 保留每个模块的日志数、崩溃数、错误数、警告数统计
- **一键清除**: "×"按钮快速清空搜索并显示所有模块
- **选择保持**: 当前选中模块仍在过滤结果中时自动保持选中状态

#### 使用示例
```
搜索"net"    → 显示：NetworkManager, NetworkService
搜索"anim"   → 显示：AnimationCenter, AnimationEngine
搜索"cache"  → 显示：CacheManager
清空搜索     → 显示所有模块
```

#### 技术实现
- 位置：`gui/mars_log_analyzer_pro.py:306-317` (UI组件)
- 过滤方法：`gui/mars_log_analyzer_pro.py:1413-1471` (filter_module_list)
- Python 3.13兼容：使用 `trace_add('write')` 实现实时监听
- 详细文档：`docs/technical/MODULE_LIST_SEARCH.md`

---

## AI 智能诊断

### 功能概述
完整的AI驱动日志分析系统，支持多AI服务、智能分析能力、隐私保护和灵活配置，为日志分析提供强大的AI辅助。

### 核心特性
- **多AI服务支持**: Claude Code（推荐）、Claude API、OpenAI、Ollama本地模型
- **智能分析能力**:
  - 🔥 崩溃分析：自动识别崩溃堆栈并提供修复建议
  - ⚡ 性能诊断：检测性能瓶颈和资源使用问题
  - 📊 问题总结：生成完整的问题报告和优先级建议
  - 🔍 智能搜索：基于AI的语义搜索和日志关联
  - 💬 自由对话：针对日志内容的交互式问答
- **AI助手侧边栏**:
  - 4个快捷操作按钮（崩溃分析/性能诊断/问题总结/智能搜索）
  - 📝 自定义Prompt按钮
  - 实时聊天界面with历史记录
  - 自由问答输入框
  - 状态管理和进度反馈
- **右键菜单增强**:
  - 🤖 AI分析此日志：分析选中的日志条目
  - 🤖 AI解释错误原因：深度分析错误成因
  - 🤖 AI查找相关日志：智能关联日志搜索
- **隐私保护**:
  - 自动过滤敏感信息（手机号/邮箱/IP/身份证等）
  - 内置白名单机制
  - 可自定义过滤规则
- **日志预处理**:
  - 崩溃提取器：自动提取崩溃堆栈和上下文
  - 错误模式识别：识别10种常见错误模式
  - 日志摘要生成：智能压缩日志内容
- **灵活配置**:
  - GUI配置对话框：服务选择、API Key管理、模型配置
  - 自动检测：优先级自动选择最佳可用服务
  - 环境变量支持：API Key通过环境变量配置
- **异步处理**：所有AI请求异步执行，不阻塞UI

### AI助手跳转功能 🎯

#### 功能概述
增强AI助手的跳转功能，提供浏览器风格的导航体验，支持多种跳转格式、历史记录管理和上下文预览。

#### 核心特性
- **三种跳转格式**:
  - 时间戳 `[...]`
  - 行号 `#123`
  - 模块名 `@Module`
- **跳转历史记录**: 浏览器风格的前进/后退按钮 (◀▶)
  - 历史栈管理：`[(log_index, timestamp), ...]`
  - 智能历史清除（后退后新跳转清除前进历史）
  - 按钮状态自动管理（禁用/启用）
  - 实时位置显示 "历史 2/5"
- **渐变动画效果**: 2秒平滑淡出高亮
  - 7步颜色渐变：`#FFFF00 → #FFFFFF`
  - 递归 `after()` 帧动画实现
  - 视觉效果自然流畅
- **上下文预览**: 悬停显示周边日志
  - 鼠标悬停显示预览窗口
  - 显示前后各2行（共5行上下文）
  - 目标行用 ➤ 标记并高亮
  - 无边框Toplevel窗口，跟随鼠标位置
  - 手型光标反馈

### 自定义Prompt功能 📝

#### 功能概述
允许用户创建、编辑和管理自定义的AI提示词模板，支持变量替换和分类管理，大幅提升AI分析的效率和准确性。

#### 核心特性
- **灵活的模板系统**:
  - 支持变量替换 `{variable_name}` 语法
  - 自动提取模板变量
  - 支持Markdown格式编写
  - 变量自动填充（如logs变量）
- **完整的CRUD操作**:
  - 创建、编辑、删除、复制模板
  - 启用/禁用控制
  - 分类管理（崩溃分析/性能诊断/自定义分析等）
  - 搜索和过滤功能
- **持久化存储**:
  - JSON格式存储在 `gui/custom_prompts.json`
  - 支持导入/导出模板
  - ID冲突自动处理
- **GUI管理界面**:
  - 📝 按钮快速访问（AI助手标题栏）
  - 直观的列表管理
  - 实时变量预览
  - 右键菜单快捷操作
- **快捷选择访问** 🎯:
  - 📝▼ 快捷按钮（AI助手输入框旁）：一键选择自定义Prompt
  - 右键菜单集成：选中日志后右键菜单"📝 使用自定义Prompt"子菜单
  - 分类展示：按类别组织Prompt，易于查找
  - 自动填充：选中日志自动作为上下文传入
- **内置示例模板**:
  - 语音问题专项分析：针对音频录制、播放、编解码问题
  - 网络问题专项分析：针对HTTP请求、连接、超时问题

### 使用方法
```bash
# 启动主程序
./scripts/run_analyzer.sh

# 右侧AI助手面板自动显示
# 1. 点击"AI设置"配置服务（推荐使用自动检测）
# 2. 点击快捷操作按钮进行分析
# 3. 或在输入框中自由提问
# 4. 右键日志可快速AI分析
# 5. 点击📝按钮使用自定义Prompt模板
```

---

## IPS 崩溃解析

### 功能概述
解析iOS崩溃报告，提供崩溃分析、符号化和问题定位功能。

### 核心特性
- iOS崩溃报告解析
- 崩溃堆栈符号化
- 关键崩溃信息提取
- 崩溃模式识别
- 修复建议生成

### 使用方法
```bash
# 解析iOS崩溃报告
python3 tools/ips_parser.py crash.ips

# 或在GUI中使用"IPS崩溃解析"标签页
```

### 支持的崩溃格式
- iOS标准崩溃报告 (.ips)
- 符号化前的崩溃报告
- 包含架构信息的崩溃报告
- 多线程崩溃报告

---

## iOS 推送测试

### 功能概述
完整的APNS推送测试工具，支持证书管理、推送发送和历史记录。

### 核心特性
- **证书管理**（支持.p12/.pem/.cer格式）
- **HTTP/2推送发送**
- **推送历史记录**
- **沙盒和生产环境支持**
- **Payload模板快速选择**
- **实时日志和历史记录**

### 使用方法

#### 独立运行
```bash
# 独立启动推送工具GUI
./scripts/run_push_tool.sh

# 或直接运行
python3 push_tools/apns_gui.py

# 命令行使用
python3 push_tools/apns_push.py --cert cert.p12 --token "device_token" --message "测试消息" --sandbox
```

#### 集成使用
在主程序中点击"iOS推送测试"标签页

### 推送证书获取
从Apple开发者中心下载，导出为.p12格式（包含私钥）

---

## iOS 沙盒浏览

### 功能概述
完整的iOS应用沙盒文件浏览器，提供设备管理、应用列表、文件浏览和文件操作功能。

### 功能特性
- **设备管理**: 自动检测iOS设备，显示完整设备名称和型号
- **智能应用列表** 🚀:
  - **预先过滤**：加载时自动检测访问权限，只显示可访问的应用
  - **实时进度**：显示访问权限检测进度（已检测 n/total）
  - **统计信息**：显示已加载和已过滤的应用数量
  - **自动加载**：首次进入时自动加载第一个可访问的应用
  - **避免错误**：用户不会看到无法访问的应用，杜绝 InstallationLookupFailed 错误
- **文件浏览**: 树形结构展示应用沙盒文件系统，支持多级目录
- **文件搜索**:
  - 🔍 支持文件名搜索：快速查找包含关键词的文件或目录
  - 📄 支持文件内容搜索：在文本文件内容中搜索关键词
  - 🚀 异步搜索：不阻塞UI的后台搜索
  - 🎯 结果高亮：搜索结果用蓝色显示，带[文件名]或[文件内容]标签
- **文件预览**:
  - 📝 文本文件：.txt, .log, .json, .xml, .plist, .html, .css, .js, .py, .md, .sh, .h, .m, .swift等
  - 🖼️ 图片文件：.png, .jpg, .jpeg, .gif, .bmp, .ico（需要Pillow库）
  - 🔢 十六进制：其他未识别格式显示hex dump
  - 💾 数据库：识别SQLite数据库文件
- **文件操作**:
  - 预览：在程序内查看文件内容（推荐用于图片）
  - 导出：将文件或目录导出到本地
  - 打开：使用系统默认程序打开文件（图片文件不支持，避免连接断开）
  - 删除：删除文件或目录（不可恢复）
  - 刷新：重新加载当前目录

### 使用方法
1. 连接iOS设备到Mac
2. 打开"iOS沙盒浏览"标签页
3. 在设备下拉框选择设备（显示设备名称、型号和UDID）
4. 等待应用列表加载（会自动过滤不可访问的应用）
5. 应用列表中只显示可访问的应用，自动加载第一个应用
6. 点击目录左侧的▶箭头展开目录
7. 双击文件预览，右键显示更多操作

### 依赖要求
```bash
pip install pymobiledevice3  # iOS设备通信
pip install Pillow           # 图片预览（可选）
```

### 注意事项
**图片文件"打开"功能限制**：打开图片文件会导致系统预览程序保持文件句柄，引发iOS设备连接断开和界面刷新（目录折叠）。

**当前解决方案**：
- ✅ 图片文件右键菜单不显示"打开"选项
- ✅ 点击底部"打开文件"按钮时给出友好提示
- ✅ 引导用户使用"预览"（程序内查看）或"导出"（保存到本地）
- ✅ 彻底避免连接断开和界面刷新问题

**推荐操作**：
- 快速查看：使用"预览"功能在程序内查看图片
- 保存使用：使用"导出"功能保存到本地后查看

---

## dSYM 分析

### 功能概述
iOS崩溃符号化和代码定位工具，帮助开发者快速定位崩溃原因。

### 核心特性
- 自动加载本地Xcode Archives文件
- 支持手动加载.dSYM文件（macOS原生文件选择器）
- 使用dwarfdump获取UUID信息
- 使用atos进行崩溃地址符号化
- 支持多架构（armv7/arm64等）
- 导出IPA功能

### 模块化架构
- **dsym_file_manager.py**：负责xcarchive/dSYM文件管理
- **dsym_uuid_parser.py**：使用dwarfdump提取UUID和架构信息
- **dsym_symbolizer.py**：使用atos进行崩溃地址符号化和IPA导出

### 使用方法
在主程序中选择"dSYM分析"标签页

---

## LinkMap 分析

### 功能概述
iOS应用二进制大小分析工具，帮助开发者优化应用包大小。

### 核心特性
- 解析Link Map文件，统计代码大小
- 符号大小统计和排序
- 未使用代码（Dead Code）分析
- 按库分组统计功能
- 搜索和过滤功能
- 格式化输出和导出报告

### 模块化架构
- **linkmap_parser.py**：专注LinkMap文件解析
- **linkmap_analyzer.py**：数据统计、分组、过滤分析
- **linkmap_formatter.py**：格式化输出和报告生成

### 使用方法
在主程序中选择"LinkMap分析"标签页

---

## iOS 代码混淆

### 功能概述
完整的iOS代码混淆解决方案，支持ObjC/Swift，提供多种混淆策略、资源处理和企业级特性，有效应对App Store审核问题。

### 核心功能
- **完整的混淆引擎**: 支持ObjC/Swift
  - 15个核心模块：配置管理、白名单、名称生成、项目分析、代码解析/转换等
  - 内置1500+系统API白名单（UIKit/Foundation/CoreGraphics等）
  - 四种命名策略：随机/前缀/模式/词典
  - 确定性混淆：固定种子保证版本迭代一致性
  - 增量混淆：仅混淆新增代码，减少变更影响

### P2高级资源处理
- **应对二进制特征检测**:
  - 图片像素微调：修改RGB值但保持视觉一致
  - Assets.xcassets处理：Contents.json同步更新
  - 音频文件hash修改：metadata和静音段处理
  - 字体文件处理：内部表和元数据修改

### 代码混淆能力
- ✅ 类名/方法名/属性名/协议名混淆
- ✅ 垃圾代码生成器（3种复杂度级别）
- ✅ 字符串加密器（4种加密算法）
- ✅ 方法重载和重写智能处理
- ✅ XIB/Storyboard类名同步更新

### 双界面支持
- **GUI界面**: 配置预设、实时进度、映射查看
- **CLI工具**: 命令行批量处理、Jenkins/CI集成

### 企业级特性
- 混淆历史管理和版本控制
- 增量编译管理（MD5变化检测）
- 性能分析和统计报告

### 性能优化 🚀
- **多线程并行解析**: 智能阈值自动选择串行/并行，性能提升 **3-5x**
- **多进程代码转换**: 绕过Python GIL，处理超大文件性能提升 **2-6x**
- **两级缓存系统**: 内存+磁盘缓存，重复构建性能提升 **100-300x**
- **测试验证**: 14/15测试通过（1个跳过），综合加速比 **103x**

### 使用方法

#### GUI使用
```bash
# 启动主程序
./scripts/run_analyzer.sh

# 在主程序中选择"iOS代码混淆"标签页
# 1. 选择项目和输出目录
# 2. 配置混淆选项（或使用快速配置模板）
# 3. 点击"开始混淆"
# 4. 查看实时进度和日志
# 5. 混淆完成后查看/导出映射文件
```

#### CLI使用
```bash
# 基础混淆（使用标准模板）
python -m gui.modules.obfuscation.obfuscation_cli \
    --project /path/to/ios/project \
    --output /path/to/obfuscated \
    --template standard

# 自定义配置
python -m gui.modules.obfuscation.obfuscation_cli \
    --project /path/to/project \
    --output /path/to/output \
    --class-names \
    --method-names \
    --property-names \
    --prefix "WHC" \
    --seed "my_project_v1.0"

# 增量混淆（保持旧版本映射）
python -m gui.modules.obfuscation.obfuscation_cli \
    --project /path/to/project \
    --output /path/to/output \
    --incremental \
    --mapping /path/to/old_mapping.json

# 只分析不混淆
python -m gui.modules.obfuscation.obfuscation_cli \
    --project /path/to/project \
    --analyze-only \
    --report analysis_report.json
```

### 详细文档
- 技术文档：`gui/modules/obfuscation/CLAUDE.md`
- 开发计划：`docs/technical/IOS_OBFUSCATION_ROADMAP.md`

---

## 性能优化

### 阶段二性能优化 🚀⚡⚡
核心性能突破已全面应用到主程序，搜索性能提升93%。

#### 倒排索引系统 🔍: 搜索性能平均提升 **92.8%**
- 索引构建速度: 79,012 条/秒
- 搜索响应时间: < 1ms（目标50ms）
- 级别/模块过滤提升: 99.7%+
- 关键词搜索提升: 75.3%

#### 流式文件加载 💾: 大文件加载能力大幅提升
- 编码检测: 0.15ms（原方案秒级）
- 加载速度: 1200万行/秒
- 内存优化: 峰值 < 文件大小2倍
- 支持GB级文件: 无大小限制
- 智能加载策略: <10MB直接加载，>=10MB流式加载

### 阶段一性能优化 🚀⚡
全面提升系统性能和用户体验。

#### 内存优化 (LogEntry.__slots__): 内存占用减少 **69.8%**
- 100万条日志: 328MB → 99MB (节省229MB)
- 单个对象: 344字节 → 104字节

#### 搜索优化 (正则预编译缓存): 搜索速度提升 **37.2%**
- 100万条正则搜索: 0.071秒 → 0.045秒
- 缓存命中时速度提升更明显 (69%)

#### UI渲染优化 (批量渲染): 渲染速度提升 **65%**
- 500条日志: 1.0秒 → 0.35秒
- 5000条日志: 0.025秒 (超快响应)

### 用户体验提升
- ⚡ 搜索即时响应 (从秒级降到毫秒级)
- 💾 支持超大文件 (GB级文件无压力)
- 🔄 实时进度显示 (索引构建、文件加载)
- 📊 多维索引加速 (词、模块、级别、时间)
- ⚡ 更快的启动速度 (内存占用减少)
- 🔍 更快的搜索响应 (正则搜索接近即时)
- 📜 更流畅的滚动体验 (无卡顿感)
- 🐛 更好的问题追踪 (完整日志系统)

---

## 常见问题

### Q: 解码后的文件在哪里？
A: 默认保存在原xlog文件同目录，文件名添加.log后缀

### Q: 如何处理加密的日志？
A: 当前工具主要处理非加密或标准加密格式，特殊加密需要提供密钥

### Q: GUI程序打不开怎么办？
A: 使用 run_analyzer.sh 脚本，它会自动安装所需依赖

### Q: 支持哪些操作系统？
A: macOS、Linux、Windows（需要Python环境）

### Q: iOS推送功能如何使用？
A: 有两种方式：
1. 在主程序中点击"iOS推送测试"标签页
2. 独立运行`./scripts/run_push_tool.sh`

### Q: 推送证书如何获取？
A: 从Apple开发者中心下载，导出为.p12格式（包含私钥）

### Q: 项目支持哪些日志格式？
A: 主要支持 Mars xlog 格式，包括压缩和加密版本

### Q: 如何优化大文件处理性能？
A:
- 使用快速解码器或优化解码器
- 启用索引构建功能
- 使用流式加载模式
- 调整内存限制设置

---

## 技术支持

- **文档**: 查看本功能说明和技术文档目录
- **问题反馈**: 通过 GitHub Issues 报告问题
- **更新日志**: 参考 [CHANGELOG.md](CHANGELOG.md)
- **开发指南**: 参考 [DEVELOPMENT.md](DEVELOPMENT.md)

---

*本文档持续更新中，最新版本请查看项目仓库。*