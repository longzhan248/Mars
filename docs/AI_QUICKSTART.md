# AI智能诊断功能 - 快速入门指南

**版本**: v1.0.0
**更新日期**: 2025-10-16

---

## 📖 目录

1. [功能概述](#功能概述)
2. [快速开始](#快速开始)
3. [功能使用](#功能使用)
4. [配置说明](#配置说明)
5. [常见问题](#常见问题)
6. [最佳实践](#最佳实践)

---

## 功能概述

Mars日志分析器集成了强大的AI智能诊断功能，可以帮助您快速分析和理解日志中的问题。

### 核心功能

- 🔥 **崩溃分析** - 自动识别崩溃堆栈并提供修复建议
- ⚡ **性能诊断** - 检测性能瓶颈和资源使用问题
- 📊 **问题总结** - 生成完整的问题报告和优先级建议
- 🔍 **智能搜索** - 基于AI的语义搜索和日志关联
- 💬 **自由对话** - 针对日志内容的交互式问答

### 支持的AI服务

- **Claude Code** (推荐) - 无需API Key，完全免费
- **Claude API** - 需要Anthropic API Key
- **OpenAI** - 需要OpenAI API Key
- **Ollama** - 本地运行，完全离线

---

## 快速开始

### 步骤1：启动程序

```bash
./scripts/run_analyzer.sh
```

### 步骤2：加载日志文件

点击"加载文件"按钮，选择要分析的日志文件。

### 步骤3：配置AI服务（首次使用）

1. 点击右侧AI助手面板的"AI设置"按钮
2. **推荐配置**：
   - ✅ 启用"自动检测最佳服务"
   - ✅ 启用"隐私信息过滤"
   - 保持其他默认值
3. 点击"测试连接"验证配置
4. 点击"保存"完成配置

### 步骤4：开始使用

- 点击快捷操作按钮（崩溃分析/性能诊断/问题总结/智能搜索）
- 或在输入框中输入问题，按Enter发送
- 或右键点击日志条目，选择AI分析选项

---

## 功能使用

### 1. 崩溃分析 🔥

**适用场景**：日志中包含崩溃堆栈信息

**使用方法**：
1. 加载包含崩溃的日志文件
2. 点击"🔥 崩溃分析"按钮
3. 等待5-15秒，AI将分析并给出：
   - 崩溃原因分析
   - 堆栈跟踪解读
   - 修复建议
   - 相关代码定位

**示例输出**：
```
【崩溃分析报告】

崩溃原因：
这是一个空指针异常(NullPointerException)，发生在NetworkManager类的
sendRequest方法中。

详细分析：
在第45行尝试调用connection.send()时，connection对象为null。
这通常是因为在网络连接未建立或已断开的情况下尝试发送请求。

修复建议：
1. 在调用send()前添加空值检查
2. 确保网络连接已成功建立
3. 添加重连机制处理连接断开的情况

相关代码：
NetworkManager.swift:45
```

### 2. 性能诊断 ⚡

**适用场景**：日志中包含性能相关信息

**使用方法**：
1. 加载包含性能日志的文件
2. 点击"⚡ 性能诊断"按钮
3. AI将识别：
   - 性能瓶颈位置
   - 资源使用异常
   - 卡顿原因分析
   - 优化建议

**示例输出**：
```
【性能诊断报告】

检测到的性能问题：

1. 主线程阻塞（高优先级）
   - 位置：ImageLoader.loadImage() - line 234
   - 问题：在主线程进行网络请求，导致UI卡顿
   - 建议：将网络请求移到后台线程

2. 内存泄漏风险（中优先级）
   - 位置：CacheManager - 多次警告内存不足
   - 问题：缓存未及时清理
   - 建议：实现LRU缓存策略，设置内存上限

性能优化优先级：
1. 主线程阻塞（立即修复）
2. 内存泄漏（本周修复）
```

### 3. 问题总结 📊

**适用场景**：需要快速了解日志中的所有问题

**使用方法**：
1. 加载日志文件
2. 点击"📊 问题总结"按钮
3. 获得完整报告：
   - 问题分类统计
   - 严重程度评估
   - 修复优先级排序
   - 问题趋势分析

**示例输出**：
```
【日志问题总结】

问题统计：
- 崩溃（Crash）：2次
- 错误（Error）：15次
- 警告（Warning）：43次

按严重程度分类：

【严重】(需立即修复)
1. NullPointerException in NetworkManager (2次)
2. OutOfMemoryError in ImageCache (1次)

【重要】(本周修复)
1. 网络请求超时 (8次)
2. 数据库查询慢 (5次)

【一般】(择机修复)
1. 缓存未命中警告 (43次)

修复建议优先级：
1. 修复空指针崩溃
2. 优化内存使用
3. 添加网络重试机制
4. 优化数据库查询
```

### 4. 智能搜索 🔍

**适用场景**：查找特定关键词或问题相关的日志

**使用方法**：
1. 点击"🔍 智能搜索"按钮
2. 在弹出对话框输入搜索关键词
3. AI会智能搜索：
   - 精确匹配
   - 语义匹配
   - 上下文关联
   - 模式识别

**示例**：
```
输入："用户登录失败"

AI搜索结果：
✓ 精确匹配：3条日志包含"登录失败"
✓ 语义匹配：5条日志包含"authentication failed"
✓ 相关日志：8条网络错误日志（可能导致登录失败）

建议：
登录失败可能与以下原因相关：
1. 网络连接问题（5次超时）
2. 服务器返回401错误（3次）
3. Token过期（2次）
```

### 5. 自由对话 💬

**适用场景**：针对日志的任何问题

**使用方法**：
1. 在AI助手面板底部输入框中输入问题
2. 按Enter键或点击"发送"按钮
3. AI会基于当前加载的日志回答

**示例对话**：
```
你："为什么会出现这么多网络超时？"

AI："根据日志分析，网络超时频繁出现的原因可能是：

1. 超时配置过短：当前设置为5秒，建议增加到10-15秒
2. 服务器响应慢：平均响应时间8秒，超过超时阈值
3. 并发请求过多：同时发起20+个请求，超过系统承载

建议：
1. 增加超时时间到15秒
2. 实现请求队列，限制并发数为5
3. 添加重试机制，3次重试间隔递增"
```

### 6. 右键菜单AI分析

**适用场景**：快速分析特定日志条目

**使用方法**：
1. 在日志查看器中选中一行或多行日志
2. 右键点击（或 Control+点击）
3. 选择AI分析选项：
   - 🤖 AI分析此日志
   - 🤖 AI解释错误原因
   - 🤖 AI查找相关日志

**优势**：
- 快速定位：直接分析选中的日志
- 上下文感知：AI会考虑前后5条日志
- 精准分析：针对性更强

### 7. 对话搜索 🔍 (Phase 3新增)

**适用场景**：在长对话历史中快速定位关键信息

**使用方法**：
1. 在对话历史上方找到搜索框
2. 输入搜索关键词（如"崩溃"、"内存"、"网络"等）
3. 所有匹配的文本会自动黄色高亮
4. 显示"找到 X 处"统计
5. 自动滚动到第一个匹配位置
6. 点击"×"按钮清除搜索

**特性**：
- ✅ 实时搜索：输入即搜索，无需点击按钮
- ✅ 不区分大小写：自动忽略大小写
- ✅ 全文高亮：所有匹配位置黄色标记
- ✅ 结果计数：显示共找到多少处匹配
- ✅ 一键清除：快速恢复正常浏览

**示例场景**：
```
场景1：查找之前讨论的崩溃
输入："空指针" → 找到3处 → 查看之前的崩溃分析

场景2：搜索特定错误代码
输入："401" → 找到5处 → 回顾所有401错误的讨论

场景3：查找优化建议
输入："优化" → 找到8处 → 汇总所有优化建议
```

### 8. 常用问题快捷按钮 (Phase 3新增)

**适用场景**：快速访问预设的常用问题

**快捷按钮**：
- 💡 性能优化 - "如何提升应用性能？有哪些优化建议？"
- 🐛 错误原因 - "这些错误的常见原因有哪些？如何避免？"
- 📝 最佳实践 - "日志记录的最佳实践是什么？"
- 🔧 调试技巧 - "如何高效地调试这类问题？"

**优势**：
- 一键触发：无需手动输入常用问题
- 提示词优化：预设问题已经过优化
- 节省时间：减少重复输入

### 9. 进度指示器 (Phase 3新增)

**功能说明**：
- AI处理时显示滚动进度条
- 配合"⏹️ 停止"按钮
- 消除"卡死"的疑虑

**视觉反馈**：
```
状态: 正在分析崩溃日志...        [⏹️ 停止]
████████████████████ (滚动动画)
```

---

## 配置说明

### 自动检测模式（推荐）

**优势**：无需配置，自动选择最佳服务

**优先级**：
1. Claude Code（如果正在运行）
2. Ollama（如果已安装并启动）
3. Claude API（如果设置了环境变量）
4. OpenAI（如果设置了环境变量）

**使用方法**：
在AI设置对话框中，启用"自动检测最佳服务"即可。

### 手动配置

#### 1. 使用Claude Code（推荐）

**优势**：
- ✅ 无需API Key
- ✅ 完全免费
- ✅ 零配置

**要求**：
- Claude Code正在运行

**配置**：
无需配置，自动检测使用。

#### 2. 使用Claude API

**优势**：
- 响应速度快
- 质量高
- 稳定可靠

**要求**：
- Anthropic API Key

**获取API Key**：
1. 访问 https://console.anthropic.com/
2. 注册/登录账号
3. 进入API Keys页面
4. 创建新的API Key
5. 复制API Key（sk-ant-开头）

**配置方法1（推荐）**：
```bash
# 设置环境变量
export ANTHROPIC_API_KEY=sk-ant-xxxxx

# 启动程序
./scripts/run_analyzer.sh
```

**配置方法2**：
1. 打开AI设置对话框
2. 取消"自动检测"
3. 选择"Claude"服务
4. 输入API Key
5. 点击"测试连接"验证
6. 点击"保存"

#### 3. 使用OpenAI

**优势**：
- 广泛使用
- 功能强大
- 文档丰富

**要求**：
- OpenAI API Key

**获取API Key**：
1. 访问 https://platform.openai.com/
2. 注册/登录账号
3. 进入API Keys页面
4. 创建新的API Key
5. 复制API Key（sk-开头）

**配置方法**：
```bash
# 设置环境变量
export OPENAI_API_KEY=sk-xxxxx

# 启动程序
./scripts/run_analyzer.sh
```

#### 4. 使用Ollama（本地模型）

**优势**：
- ✅ 完全免费
- ✅ 数据不出机器
- ✅ 完全离线使用
- ✅ 无隐私顾虑

**要求**：
- 已安装Ollama
- 已下载模型

**安装步骤**：
```bash
# 1. 安装Ollama
brew install ollama

# 2. 下载模型（推荐llama3）
ollama pull llama3

# 3. 启动Ollama服务
ollama serve

# 4. 启动Mars日志分析器
./scripts/run_analyzer.sh
```

**配置**：
无需配置，自动检测使用。

### 高级配置

#### 调整Max Tokens

**作用**：控制AI响应的最大长度

**建议值**：
- 短文本分析：1000-5000
- 中等复杂度：5000-10000（默认）
- 复杂问题：10000-100000

**配置方法**：
AI设置 → Max Tokens → 输入数值 → 保存

#### 调整超时时间

**作用**：防止长时间等待

**建议值**：
- 快速分析：30秒
- 正常使用：60秒（默认）
- 复杂分析：120-300秒

**配置方法**：
AI设置 → 超时时间 → 选择时长 → 保存

#### 隐私过滤配置

**作用**：自动过滤敏感信息

**默认过滤**：
- 手机号：138****5678
- 邮箱：u***r@example.com
- IP地址：192.168.*.*
- 身份证号：前6后4保留
- Token/API Key：完全隐藏

**建议**：
✅ 始终启用（默认已启用）

---

## 常见问题

### Q1: AI服务初始化失败？

**可能原因**：
1. Claude Code未运行
2. API Key无效
3. 网络连接问题
4. Ollama服务未启动

**解决方案**：
1. 检查Claude Code是否运行
2. 验证API Key是否正确
3. 检查网络连接
4. 确保Ollama已启动：`ollama serve`

### Q2: 请求超时？

**可能原因**：
1. 网络速度慢
2. 日志内容过长
3. 超时设置过短

**解决方案**：
1. 检查网络连接
2. 减少分析的日志数量
3. 增加超时时间（AI设置 → 超时时间）
4. 减少Max Tokens（AI设置 → Max Tokens）

### Q3: AI分析结果不准确？

**可能原因**：
1. 日志信息不完整
2. 日志格式不标准
3. 上下文不足

**解决方案**：
1. 提供完整的日志文件
2. 使用右键菜单分析单条日志（包含上下文）
3. 在自由对话中提供更多背景信息
4. 使用更高级的模型（如GPT-4）

### Q4: 隐私信息被过滤掉了？

**这是正常行为**，隐私过滤功能会自动脱敏：
- 手机号
- 邮箱
- IP地址
- Token/密钥

**如需关闭**：
AI设置 → 取消"启用隐私信息过滤" → 保存

⚠️ **警告**：关闭后，敏感信息可能被发送到AI服务

### Q5: 费用问题？

**免费选项**：
- ✅ Claude Code - 完全免费
- ✅ Ollama - 完全免费

**付费选项**：
- Claude API - 按Token计费
- OpenAI - 按Token计费

**节省费用的建议**：
1. 优先使用Claude Code或Ollama
2. 减少Max Tokens设置
3. 使用问题总结而非逐条分析
4. 启用隐私过滤（减少发送内容）

---

## 最佳实践

### 1. 日志分析流程

**推荐步骤**：
1. **加载日志** → 选择要分析的日志文件
2. **快速总结** → 点击"问题总结"了解全局
3. **重点分析** → 针对严重问题使用"崩溃分析"或"性能诊断"
4. **深入探索** → 使用右键菜单分析具体日志条目
5. **交互问答** → 自由对话解决疑问

### 2. 提高分析准确性

✅ **提供完整日志**：包含足够的上下文信息
✅ **使用标准格式**：Mars日志格式识别度更高
✅ **选择合适的AI服务**：复杂问题使用GPT-4或Claude
✅ **启用隐私过滤**：保护敏感信息

### 3. 性能优化建议

✅ **大文件分析**：使用"问题总结"而非逐条分析
✅ **批量处理**：先过滤日志，再使用AI分析
✅ **合理设置Max Tokens**：避免超长响应
✅ **使用缓存**：相似问题会更快响应

### 4. 团队协作建议

✅ **统一配置**：使用环境变量统一API Key
✅ **分享发现**：导出AI分析结果共享给团队
✅ **建立知识库**：记录常见问题的AI分析结果
✅ **保护隐私**：始终启用隐私过滤功能

### 5. 故障排查技巧

✅ **问题定位**：使用"智能搜索"快速找到问题日志
✅ **根因分析**：使用右键"AI解释错误原因"深入分析
✅ **关联分析**：使用"AI查找相关日志"发现隐藏联系
✅ **解决方案**：自由对话请求具体的修复建议

---

## 反馈和支持

### 问题反馈

如遇到问题，请提供以下信息：
1. 错误提示截图
2. 日志文件示例
3. 配置信息（AI服务类型、模型等）
4. 操作步骤

### 技术支持

- **技术文档**：`docs/technical/AI_INTEGRATION_COMPLETE.md`
- **API文档**：`gui/modules/ai_diagnosis/CLAUDE.md`
- **问题跟踪**：GitHub Issues

---

## 更新日志

### v1.1.0 (2025-10-17)
- ✅ **Phase 3 完成** - 用户体验优化
  - 🎯 P3-1: 添加进度条指示器 - 可视化AI处理状态
  - ⚡ P3-2: 添加常用问题快捷按钮 + 布局优化 - 快速访问预设问题
  - 🔍 P3-3: 添加对话搜索功能 - 快速定位历史对话
- ✅ **Phase 2 完成** - 高级交互功能
  - 💾 P2-1: 导出对话功能 - 保存分析结果
  - 🎯 P2-2: 右键菜单应用上下文配置 - 智能上下文感知
  - 📊 P2-3: Token累计统计 - 成本追踪

### v1.0.0 (2025-10-16)
- 🎉 初始版本发布
- ✅ 支持4种AI服务
- ✅ 5种核心分析功能
- ✅ 完整的隐私保护
- ✅ 友好的用户界面

---

**文档版本**: 1.1.0
**最后更新**: 2025-10-17
**维护者**: Mars Log Analyzer Team
